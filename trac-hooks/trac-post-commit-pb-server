import socket, os

from twisted.python import log
from twisted.spread import pb
from twisted.internet import utils

wolfwood = socket.gethostbyname('svn.twistedmatrix.com')
postCommitHook = '/home/trac-migration/Run/trac/trac-post-commit-hook'
tracEnvPath = '/home/trac-migration/Run/trac/trac-projects/twisted/'
tracURL = 'http://twistedmatrix.com/trac/'

tracCommitServerPort = 38159

class TracPostCommitPbServerRoot(pb.Root):
    def __init__(self, allowedIP, tracEnvPath, tracURL):
        self.allowedIP = allowedIP
        self.tracEnvPath = tracEnvPath
        self.tracURL = tracURL


    def remote_postCommit(self, revision, author, msg):
        log.msg("postCommit(revision=%r)" % (revision,))
        result = utils.getProcessOutput(
            postCommitHook, ['-p', tracEnvPath,
                             '-r', str(revision),
                             '-u', author,
                             '-m', msg,
                             '-s', tracURL],
            errortoo=True, env=os.environ)
        def hooked(result):
            log.msg("hook completed: %r" % (result,))
            return result
        def failed(reason):
            log.err(reason, "hook failed")
            return reason
        result.addCallbacks(hooked, failed)
        return result



class TracPostCommitPbServerRootFactory(pb.PBServerFactory):
    def buildProtocol(self, addr):
        if addr.host != wolfwood:
            raise Exception("DISALLOWED")
        return pb.PBServerFactory.buildProtocol(self, addr)


from twisted.application import service, internet
application = service.Application('Trac Post Commit PB Server')
svc = internet.TCPServer(
    tracCommitServerPort,
    TracPostCommitPbServerRootFactory(
        TracPostCommitPbServerRoot(wolfwood, tracEnvPath, tracURL)))
svc.setServiceParent(application)
